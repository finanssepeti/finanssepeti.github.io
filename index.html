<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans Sepeti | Pro Terminal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --p: #1a237e; --s: #00e676; --d: #ff1744; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        header { background: var(--p); color: white; padding: 20px; text-align: center; }
        .nav-tabs { background: #fff; display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-x: auto; }
        .tab-btn { padding: 15px 20px; border: none; background: none; font-weight: bold; cursor: pointer; color: #555; white-space: nowrap; }
        .tab-btn.active { color: var(--p); border-bottom: 3px solid var(--p); }
        .container { padding: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .page { display: none; } .page.active { display: block; }
        .chart-controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; background: #eceff1; padding: 10px; border-radius: 8px; }
        .chart-btn { background: #2c3e50; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; }
        .chart-btn:hover { background: #34495e; }
        #tradingview_terminal { height: 750px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .profit { color: var(--s); font-weight: bold; } .loss { color: var(--d); font-weight: bold; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
    </style>
</head>
<body>

<header>
    <h1>FİNANS SEPETİ</h1>
    <p>Profesyonel Piyasa Takip ve Analiz Terminali</p>
</header>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="showPage('piyasalar')">Piyasalar</button>
    <button class="tab-btn" onclick="showPage('yatirim-ekle')">Yatırım Ekle</button>
    <button class="tab-btn" onclick="showPage('portfoy')">Portföyüm</button>
    <button class="tab-btn" onclick="showPage('grafik-terminali')">Canlı Grafikler</button>
</div>

<div class="container">
    
    <div id="piyasalar" class="page active">
        <div class="card">
            <h3>Canlı Gösterge Paneli</h3>
            <div id="live-prices" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                Veriler yükleniyor... (TwelveData API limitine takılmış olabilir, lütfen bekleyin)
            </div>
        </div>
    </div>

    <div id="yatirim-ekle" class="page">
        <div class="card" style="max-width: 500px; margin: auto;">
            <h3>Yeni Yatırım Kaydı</h3>
            <label>Varlık Tipi:</label>
            <select id="asset-type">
                <option value="XAU/USD">Gram Altın (TL)</option>
                <option value="XAG/USD">Gram Gümüş (TL)</option>
                <option value="BTC/USD">Bitcoin (USD)</option>
                <option value="BIST:THYAO">Hisse Senedi (BIST)</option>
            </select>
            <label>Miktar (Adet/Gram):</label>
            <input type="number" id="asset-amount" placeholder="Örn: 5.40">
            <label>Alış Birim Fiyatı (TL/USD):</label>
            <input type="number" id="buy-price" placeholder="Örn: 3050.00">
            <label>İşlem Tarihi:</label>
            <input type="date" id="invest-date">
            <button onclick="saveAsset()" style="width:100%; padding:15px; background:var(--p); color:white; border:none; font-weight:bold; border-radius:8px;">Cüzdanıma Kaydet</button>
        </div>
    </div>

    <div id="portfoy" class="page">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Yatırım Portföyüm</h3>
                <button onclick="downloadPDF()" style="background:#444; color:white; padding:8px 15px; border:none; border-radius:5px; cursor:pointer;">PDF İndir</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="portfolio-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Varlık</th>
                            <th>Adet</th>
                            <th>Alış Birim</th>
                            <th>Güncel Birim</th>
                            <th>Toplam Yatırım</th>
                            <th>Kar/Zarar</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="grafik-terminali" class="page">
        <div class="card">
            <h3>Teknik Analiz Terminali (MA50, MA200, RSI Aktif)</h3>
            <div class="chart-controls">
                <button class="chart-btn" onclick="loadSymbol('FX:USDTRY')">1. Dolar/TL</button>
                <button class="chart-btn" onclick="loadSymbol('OANDA:XAUUSD')">2. Altın/Ons</button>
                <button class="chart-btn" onclick="loadSymbol('OANDA:XAGUSD')">3. Gümüş/Ons</button>
                <button class="chart-btn" onclick="loadSymbol('FX_IDC:XAUTRYG')">4. Altın/TL</button>
                <button class="chart-btn" onclick="loadSymbol('FX_IDC:XAGTRYG')">5. Gümüş/TL</button>
                <button class="chart-btn" onclick="loadSymbol('BINANCE:BTCUSDT')">6. BTC/USDT</button>
                <button class="chart-btn" onclick="loadSymbol('BIST:XU100')" style="background:#004d40;">7. BIST100</button>
            </div>
            <div id="tradingview_terminal"></div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    const API_KEY = '72ce0236fb66434e8feed08c1b2044d2';
    let currentPrices = {};

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(event && event.currentTarget) event.currentTarget.classList.add('active');
        if(id === 'grafik-terminali') loadSymbol('FX:USDTRY');
    }

    async function syncPrices() {
        try {
            const syms = "XAU/USD,XAG/USD,USD/TRY,BTC/USD,THYAO.IS";
            const resp = await fetch(`https://api.twelvedata.com/price?symbol=${syms}&apikey=${API_KEY}`);
            const data = await resp.json();
            
            const usd = parseFloat(data['USD/TRY']?.price || 1);
            currentPrices = {
                'XAU/USD': (parseFloat(data['XAU/USD']?.price || 0) / 31.10) * usd,
                'XAG/USD': (parseFloat(data['XAG/USD']?.price || 0) / 31.10) * usd,
                'BTC/USD': parseFloat(data['BTC/USD']?.price || 0) * usd,
                'BIST:THYAO': parseFloat(data['THYAO.IS']?.price || 0),
                'USD/TRY': usd
            };
            refreshUI();
        } catch (e) { console.log("Veri çekme hatası - Limit!"); }
    }

    function refreshUI() {
        const pricesDiv = document.getElementById('live-prices');
        if(currentPrices['USD/TRY']) {
            pricesDiv.innerHTML = `
                <div class="card" style="text-align:center">Gram Altın<br><b>${currentPrices['XAU/USD'].toFixed(2)} TL</b></div>
                <div class="card" style="text-align:center">Gram Gümüş<br><b>${currentPrices['XAG/USD'].toFixed(2)} TL</b></div>
                <div class="card" style="text-align:center">Dolar/TL<br><b>${currentPrices['USD/TRY'].toFixed(2)} TL</b></div>
                <div class="card" style="text-align:center">BTC/TL<br><b>${currentPrices['BTC/USD'].toLocaleString()} TL</b></div>
            `;
        }
        renderTable();
    }

    function saveAsset() {
        const item = {
            sym: document.getElementById('asset-type').value,
            amt: parseFloat(document.getElementById('asset-amount').value),
            buy: parseFloat(document.getElementById('buy-price').value),
            dt: document.getElementById('invest-date').value
        };
        if(!item.amt || !item.buy) return alert("Eksik bilgi!");
        let myData = JSON.parse(localStorage.getItem('finans_v1')) || [];
        myData.push(item);
        localStorage.setItem('finans_v1', JSON.stringify(myData));
        alert("Başarıyla kaydedildi.");
        renderTable();
    }

    function renderTable() {
        const myData = JSON.parse(localStorage.getItem('finans_v1')) || [];
        const body = document.getElementById('portfolio-body');
        body.innerHTML = '';

        myData.forEach(i => {
            const live = currentPrices[i.sym] || 0;
            const total = live * i.amt;
            const pl = (live - i.buy) * i.amt;
            const plPerc = i.buy > 0 ? ((live - i.buy) / i.buy) * 100 : 0;

            body.innerHTML += `
                <tr>
                    <td>${i.dt}</td>
                    <td>${i.sym}</td>
                    <td>${i.amt}</td>
                    <td>${i.buy.toFixed(2)}</td>
                    <td>${live.toFixed(2)}</td>
                    <td><b>${total.toLocaleString()} TL</b></td>
                    <td class="${pl >= 0 ? 'profit' : 'loss'}">
                        ${pl.toFixed(2)} TL (${plPerc.toFixed(2)}%)
                    </td>
                </tr>
            `;
        });
    }

    function loadSymbol(s) {
        new TradingView.widget({
            "autosize": true,
            "symbol": s,
            "interval": "D",
            "timezone": "Europe/Istanbul",
            "theme": "light",
            "style": "1",
            "locale": "tr",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": true, // ARAMA BUTONU AKTİF
            "hide_side_toolbar": false, // ÇİZİM ARAÇLARI AKTİF
            "withdateranges": true,
            "studies": [
                "RSI@tv-basicstudies",
                "MASimple@tv-basicstudies", // MA 1 (Ayarlardan 50 yapılabilir)
                "MASimple@tv-basicstudies"  // MA 2 (Ayarlardan 200 yapılabilir)
            ],
            "container_id": "tradingview_terminal"
        });
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Finans Sepeti - Yatirim Portfoyu", 14, 15);
        doc.autoTable({ html: '#portfolio-table', startY: 25 });
        doc.save("yatirimlarim.pdf");
    }

    syncPrices();
    setInterval(syncPrices, 60000);
</script>
</body>
</html>
