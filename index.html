<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const API_KEY = '72ce0236fb66434e8feed08c1b2044d2';
    let myPortfolio = JSON.parse(localStorage.getItem('f_final_v5')) || [];

    // --- 1. CANLI FİYAT ÇEKME FONKSİYONU (KRİPTO & HİSSE) ---
    async function getLivePrice(symbol, isCrypto) {
        try {
            if (isCrypto) {
                const r = await fetch(`https://api.gateio.ws/api/v4/spot/tickers?currency_pair=${symbol.replace("/USD","")}_USDT`);
                const d = await r.json();
                return d[0] ? parseFloat(d[0].last) : 0;
            } else {
                let sym = (symbol.includes(".") || symbol.includes("/")) ? symbol : symbol + ".IS";
                const r = await fetch(`https://api.twelvedata.com/price?symbol=${sym}&apikey=${API_KEY}`);
                const d = await r.json();
                return d.price ? parseFloat(d.price) : 0;
            }
        } catch (e) { return 0; }
    }

    // --- 2. PORTFÖYÜ HESAPLA VE GÜNCELLE ---
    async function renderPortfolio() {
        const tbody = document.getElementById('p-body');
        tbody.innerHTML = '<tr><td colspan="6">Veriler güncelleniyor...</td></tr>';
        
        let totalInvestment = 0;
        let totalCurrentValue = 0;
        
        const rows = [];
        for (let item of myPortfolio) {
            // Anlık fiyatı çek (Gate.io veya Yahoo/Twelve)
            const isCrypto = item.type === "Cryptocurrency";
            const currentPrice = await getLivePrice(item.varlik, isCrypto);
            
            const investment = item.miktar * item.maliyet;
            const currentVal = item.miktar * currentPrice;
            const profitLoss = currentVal - investment;
            const plPercent = ((profitLoss / investment) * 100).toFixed(2);
            
            totalInvestment += investment;
            totalCurrentValue += currentVal;

            const color = profitLoss >= 0 ? "#2ecc71" : "#e74c3c";

            rows.push(`
                <tr>
                    <td>${item.tarih}</td>
                    <td><b>${item.varlik}</b></td>
                    <td>${item.miktar}</td>
                    <td>${parseFloat(item.maliyet).toFixed(2)} ₺</td>
                    <td style="color:${color}"><b>${currentPrice.toFixed(2)} ₺</b></td>
                    <td style="color:${color}; font-weight:bold;">
                        ${profitLoss.toFixed(2)} ₺ (${plPercent}%)
                    </td>
                </tr>
            `);
        }

        tbody.innerHTML = rows.join('');
        updateChart(); // Grafiği tazele
    }

    // --- 3. DİKEY KAR/ZARAR GRAFİĞİ ---
    let myChart;
    function updateChart() {
        const ctx = document.getElementById('portfolioChart').getContext('2d');
        const labels = myPortfolio.map(i => i.varlik);
        const dataValues = myPortfolio.map(i => {
             // Basit bir anlık değer gösterimi
             return i.miktar * i.maliyet; 
        });

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Yatırım Dağılımı (Maliyet Bazlı)',
                    data: dataValues,
                    backgroundColor: '#1a237e',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- 4. KAYIT VE HESAPLAMA ---
    function saveInv() {
        const type = document.getElementById('sel-name').getAttribute('data-type');
        const obj = {
            tarih: document.getElementById('invest-date').value,
            varlik: document.getElementById('a-search').value,
            miktar: parseFloat(document.getElementById('a-qty').value),
            maliyet: parseFloat(document.getElementById('a-buy').value),
            type: type
        };
        
        if(!obj.tarih || !obj.varlik || !obj.miktar) return alert("Eksik alanları doldurun!");
        
        myPortfolio.push(obj);
        localStorage.setItem('f_final_v5', JSON.stringify(myPortfolio));
        renderPortfolio();
        alert("Portföy güncellendi.");
    }
</script>

<div id="portfoyum" class="page">
    <div class="card">
        <h3><i class="fas fa-wallet"></i> Portföy Durumu (Canlı)</h3>
        <canvas id="portfolioChart" style="max-height: 250px; margin-bottom: 30px;"></canvas>
        <div style="overflow-x: auto;">
            <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="text-align:left; border-bottom: 2px solid #ddd;">
                        <th>Tarih</th>
                        <th>Varlık</th>
                        <th>Miktar</th>
                        <th>Maliyet</th>
                        <th>Güncel</th>
                        <th>Kar/Zarar</th>
                    </tr>
                </thead>
                <tbody id="p-body">
                    </tbody>
            </table>
        </div>
        <button onclick="renderPortfolio()" style="margin-top:15px; padding:10px; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer;">
            <i class="fas fa-sync"></i> Fiyatları Güncelle
        </button>
    </div>
</div>
