<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans Sepeti | Profesyonel Takip</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --p: #1a237e; --s: #00e676; --d: #ff1744; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        header { background: var(--p); color: white; padding: 30px; text-align: center; }
        .nav-tabs { background: #fff; display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-btn { padding: 15px 20px; border: none; background: none; font-weight: bold; cursor: pointer; color: #555; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--p); border-bottom-color: var(--p); }
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .page { display: none; } .page.active { display: block; }
        input, select, button { padding: 12px; margin: 8px 0; width: 100%; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .profit { color: var(--s); font-weight: bold; } .loss { color: var(--d); font-weight: bold; }
        #tradingview_canvas { height: 600px; border-radius: 8px; overflow: hidden; }
    </style>
</head>
<body>

<header>
    <h1>FİNANS SEPETİ</h1>
    <p>Canlı Fiyatlar & Teknik Analiz Portalı</p>
</header>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="showPage('piyasalar')">Piyasalar</button>
    <button class="tab-btn" onclick="showPage('yatirim-ekle')">Yatırım Ekle</button>
    <button class="tab-btn" onclick="showPage('portfoy')">Portföyüm</button>
    <button class="tab-btn" onclick="showPage('grafik-sayfasi')">Teknik Analiz</button>
</div>

<div class="container">
    <div id="piyasalar" class="page active">
        <div class="card">
            <h3>Anlık Göstergeler</h3>
            <div id="live-prices-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                Veriler yükleniyor...
            </div>
        </div>
    </div>

    <div id="yatirim-ekle" class="page">
        <div class="card">
            <h3>Yeni Yatırım Kaydı</h3>
            <select id="asset-type">
                <option value="XAU/USD">Gram Altın (TL)</option>
                <option value="XAG/USD">Gram Gümüş (TL)</option>
                <option value="BTC/USD">Bitcoin (BTC)</option>
                <option value="THYAO.IS">THY (Hisse)</option>
            </select>
            <input type="number" id="asset-amount" placeholder="Miktar (Adet/Gram)">
            <input type="number" id="buy-price" placeholder="Alış Birim Fiyatı (TL)">
            <input type="date" id="invest-date">
            <button onclick="saveToStorage()">Portföye Kaydet</button>
        </div>
    </div>

    <div id="portfoy" class="page">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Yatırım Takip Tablosu</h3>
                <button onclick="downloadPDF()" style="width:auto; padding:5px 15px; background:#333;">PDF İndir</button>
            </div>
            <table id="portfolio-table">
                <thead>
                    <tr>
                        <th>Varlık</th>
                        <th>Adet</th>
                        <th>Alış</th>
                        <th>Güncel</th>
                        <th>Toplam Yatırım</th>
                        <th>Kar/Zarar</th>
                    </tr>
                </thead>
                <tbody id="portfolio-body"></tbody>
            </table>
        </div>
    </div>

    <div id="grafik-sayfasi" class="page">
        <div class="card">
            <h3>Gelişmiş Teknik Analiz (Çizim Araçlı)</h3>
            <div style="margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                <button style="width:auto" onclick="changeChart('XAUUSD')">Altın</button>
                <button style="width:auto" onclick="changeChart('BTCUSDT')">Bitcoin</button>
                <button style="width:auto" onclick="changeChart('BIST:THYAO')">THY</button>
            </div>
            <div id="tradingview_canvas"></div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    const API_KEY = '72ce0236fb66434e8feed08c1b2044d2';
    let prices = {};

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'grafik-sayfasi') changeChart('XAUUSD');
    }

    async function getPrices() {
        try {
            const symbols = "XAU/USD,XAG/USD,USD/TRY,BTC/USD,THYAO.IS";
            const response = await fetch(`https://api.twelvedata.com/price?symbol=${symbols}&apikey=${API_KEY}`);
            const data = await response.json();
            
            const usd = parseFloat(data['USD/TRY'].price);
            prices = {
                'XAU/USD': (parseFloat(data['XAU/USD'].price) / 31.1035) * usd,
                'XAG/USD': (parseFloat(data['XAG/USD'].price) / 31.1035) * usd,
                'BTC/USD': parseFloat(data['BTC/USD'].price) * usd,
                'THYAO.IS': parseFloat(data['THYAO.IS'].price),
                'USD/TRY': usd
            };
            updateUI();
        } catch (e) { document.getElementById('live-prices-grid').innerText = "Hata: Limit aşıldı."; }
    }

    function updateUI() {
        document.getElementById('live-prices-grid').innerHTML = `
            <div class="card">Altın: <b>${prices['XAU/USD'].toFixed(2)} TL</b></div>
            <div class="card">Dolar: <b>${prices['USD/TRY'].toFixed(2)} TL</b></div>
        `;
        renderPortfolio();
    }

    function saveToStorage() {
        const inv = {
            symbol: document.getElementById('asset-type').value,
            amount: parseFloat(document.getElementById('asset-amount').value),
            buyPrice: parseFloat(document.getElementById('buy-price').value),
            date: document.getElementById('invest-date').value
        };
        let list = JSON.parse(localStorage.getItem('my_assets')) || [];
        list.push(inv);
        localStorage.setItem('my_assets', JSON.stringify(list));
        alert("Kaydedildi!");
        renderPortfolio();
    }

    function renderPortfolio() {
        const list = JSON.parse(localStorage.getItem('my_assets')) || [];
        const body = document.getElementById('portfolio-body');
        body.innerHTML = '';

        list.forEach(item => {
            const current = prices[item.symbol] || 0;
            const total = item.amount * current;
            const diff = (current - item.buyPrice) * item.amount;
            
            body.innerHTML += `
                <tr>
                    <td>${item.symbol}</td>
                    <td>${item.amount}</td>
                    <td>${item.buyPrice}</td>
                    <td>${current.toFixed(2)}</td>
                    <td><b>${total.toLocaleString()} TL</b></td>
                    <td class="${diff >= 0 ? 'profit' : 'loss'}">${diff.toFixed(2)} TL</td>
                </tr>
            `;
        });
    }

    function changeChart(sym) {
        new TradingView.widget({
            "autosize": true,
            "symbol": sym,
            "interval": "D",
            "timezone": "Europe/Istanbul",
            "theme": "light",
            "style": "1",
            "locale": "tr",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "withdateranges": true,
            "hide_side_toolbar": false, // Çizim araçlarını açar
            "allow_symbol_change": true,
            "details": true,
            "hotlist": true,
            "calendar": true,
            "studies": [ "RSI@tv-basicstudies", "MAExp@tv-basicstudies", "MAExp@tv-basicstudies" ], // RSI ve 2 adet MA
            "container_id": "tradingview_canvas"
        });
    }

    getPrices();
    setInterval(getPrices, 60000);
</script>
</body>
</html>
