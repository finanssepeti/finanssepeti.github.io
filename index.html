import customtkinter as ctk
from tkinter import ttk, messagebox
import yfinance as yf
import sqlite3
from datetime import datetime
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg

# --- GÃ¶rÃ¼nÃ¼m AyarlarÄ± ---
ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("blue")

class YatirimUygulamasi(ctk.CTk):
    def __init__(self):
        super().__init__()

        self.title("YatÄ±rÄ±m PortfÃ¶y Analiz Sistemi v2.0")
        self.geometry("1200x700")

        self.db_hazirla()

        # --- ANA DÃœZEN ---
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)

        # --- SOL PANEL (Kontrol Paneli) ---
        self.sidebar = ctk.CTkFrame(self, width=280)
        self.sidebar.grid(row=0, column=0, sticky="nsew", padx=10, pady=10)

        ctk.CTkLabel(self.sidebar, text="ðŸ“Š PORTFÃ–Y YÃ–NETÄ°MÄ°", font=("Arial", 20, "bold")).pack(pady=20)

        self.ent_kod = ctk.CTkEntry(self.sidebar, placeholder_text="Sembol (BTC-USD, GC=F, THYAO.IS)")
        self.ent_kod.pack(pady=5, padx=20, fill="x")

        self.ent_miktar = ctk.CTkEntry(self.sidebar, placeholder_text="Adet/Miktar")
        self.ent_miktar.pack(pady=5, padx=20, fill="x")

        self.ent_fiyat = ctk.CTkEntry(self.sidebar, placeholder_text="AlÄ±ÅŸ Birim FiyatÄ±")
        self.ent_fiyat.pack(pady=5, padx=20, fill="x")

        self.btn_kaydet = ctk.CTkButton(self.sidebar, text="YatÄ±rÄ±mÄ± Kaydet", command=self.yatirim_kaydet)
        self.btn_kaydet.pack(pady=15, padx=20, fill="x")

        ctk.CTkLabel(self.sidebar, text="GRAFÄ°K SEÃ‡ENEKLERÄ°", font=("Arial", 14, "bold")).pack(pady=(20, 5))
        
        self.btn_pasta = ctk.CTkButton(self.sidebar, text="VarlÄ±k DaÄŸÄ±lÄ±mÄ± (Pasta)", fg_color="#E67E22", command=self.grafik_pasta)
        self.btn_pasta.pack(pady=5, padx=20, fill="x")

        self.btn_cubuk = ctk.CTkButton(self.sidebar, text="Zamana GÃ¶re KÃ¢r/Zarar", fg_color="#9B59B6", command=self.grafik_cubuk)
        self.btn_cubuk.pack(pady=5, padx=20, fill="x")

        self.btn_temizle = ctk.CTkButton(self.sidebar, text="GrafiÄŸi Kapat", fg_color="gray", command=self.grafik_temizle)
        self.btn_temizle.pack(pady=20, padx=20, fill="x")

        # --- SAÄž PANEL (Tablo ve Grafikler) ---
        self.right_frame = ctk.CTkFrame(self)
        self.right_frame.grid(row=0, column=1, sticky="nsew", padx=10, pady=10)

        # Tablo
        self.tablo_frame = ctk.CTkFrame(self.right_frame)
        self.tablo_frame.pack(fill="both", expand=True, padx=10, pady=10)

        self.tablo = ttk.Treeview(self.tablo_frame, columns=("Tarih", "Kod", "Miktar", "AlÄ±ÅŸ", "GÃ¼ncel", "K/Z TL", "K/Z %"), show='headings')
        for col in self.tablo["columns"]:
            self.tablo.heading(col, text=col)
            self.tablo.column(col, width=100, anchor="center")
        self.tablo.pack(fill="both", expand=True)

        # Grafik AlanÄ± (BaÅŸlangÄ±Ã§ta boÅŸ)
        self.canvas_frame = ctk.CTkFrame(self.right_frame, height=300)
        self.canvas_frame.pack(fill="both", expand=True, padx=10, pady=10)
        self.canvas = None

        self.tabloyu_doldur()

    def db_hazirla(self):
        conn = sqlite3.connect('yatirim_v2.db')
        conn.execute("CREATE TABLE IF NOT EXISTS yatirimlar (id INTEGER PRIMARY KEY, tarih TEXT, kod TEXT, miktar REAL, alis REAL)")
        conn.commit()
        conn.close()

    def yatirim_kaydet(self):
        try:
            kod, miktar, fiyat = self.ent_kod.get().upper(), float(self.ent_miktar.get()), float(self.ent_fiyat.get())
            tarih = datetime.now().strftime("%Y-%m-%d")
            conn = sqlite3.connect('yatirim_v2.db')
            conn.execute("INSERT INTO yatirimlar (tarih, kod, miktar, alis) VALUES (?, ?, ?, ?)", (tarih, kod, miktar, fiyat))
            conn.commit()
            conn.close()
            messagebox.showinfo("BaÅŸarÄ±lÄ±", "YatÄ±rÄ±m eklendi.")
            self.tabloyu_doldur()
        except:
            messagebox.showerror("Hata", "LÃ¼tfen deÄŸerleri kontrol edin.")

    def tabloyu_doldur(self):
        for i in self.tablo.get_children(): self.tablo.delete(i)
        conn = sqlite3.connect('yatirim_v2.db')
        rows = conn.execute("SELECT * FROM yatirimlar").fetchall()
        conn.close()

        for row in rows:
            f = self.fiyat_cek(row[2])
            if f:
                kz_tl = (row[3] * f) - (row[3] * row[4])
                kz_p = (kz_tl / (row[3] * row[4])) * 100
                self.tablo.insert("", "end", values=(row[1], row[2], row[3], row[4], f, round(kz_tl,2), f"%{round(kz_p,2)}"))

    def fiyat_cek(self, kod):
        try: return round(yf.Ticker(kod).history(period='1d')['Close'].iloc[-1], 2)
        except: return None

    def grafik_temizle(self):
        if self.canvas:
            self.canvas.get_tk_widget().destroy()
            self.canvas = None

    def grafik_pasta(self):
        self.grafik_temizle()
        conn = sqlite3.connect('yatirim_v2.db')
        data = conn.execute("SELECT kod, miktar, alis FROM yatirimlar").fetchall()
        conn.close()
        
        if not data: return
        
        labels = [d[0] for d in data]
        values = [d[1] * d[2] for d in data] # Toplam maliyet bazlÄ± daÄŸÄ±lÄ±m

        fig, ax = plt.subplots(figsize=(5, 4), dpi=100)
        fig.patch.set_facecolor('#2b2b2b')
        ax.pie(values, labels=labels, autopct='%1.1f%%', textprops={'color':"w"})
        ax.set_title("PortfÃ¶y DaÄŸÄ±lÄ±mÄ± (Maliyet BazlÄ±)", color="w")

        self.canvas = FigureCanvasTkAgg(fig, master=self.canvas_frame)
        self.canvas.draw()
        self.canvas.get_tk_widget().pack(fill="both", expand=True)

    def grafik_cubuk(self):
        self.grafik_temizle()
        conn = sqlite3.connect('yatirim_v2.db')
        data = conn.execute("SELECT tarih, kod, miktar, alis FROM yatirimlar ORDER BY tarih").fetchall()
        conn.close()

        if not data: return

        tarihler = [d[0] for d in data]
        kazanclar = []
        for d in data:
            guncel = self.fiyat_cek(d[1])
            kazanclar.append((d[2] * guncel) - (d[2] * d[3]) if guncel else 0)

        fig, ax = plt.subplots(figsize=(5, 4), dpi=100)
        fig.patch.set_facecolor('#2b2b2b')
        ax.set_facecolor('#2b2b2b')
        
        renkler = ['green' if x > 0 else 'red' for x in kazanclar]
        ax.bar(tarihler, kazanclar, color=renkler)
        ax.tick_params(axis='x', colors='white', rotation=45)
        ax.tick_params(axis='y', colors='white')
        ax.set_title("Tarihe GÃ¶re KÃ¢r/Zarar Durumu (TL)", color="w")

        self.canvas = FigureCanvasTkAgg(fig, master=self.canvas_frame)
        self.canvas.draw()
        self.canvas.get_tk_widget().pack(fill="both", expand=True)

if __name__ == "__main__":
    app = YatirimUygulamasi()
    app.mainloop()
