<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans Sepeti - Pro V16 Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --bg: #e0e5ec;
            --shadow: 9px 9px 16px rgb(163,177,198,0.6), -9px -9px 16px rgba(255,255,255, 0.5);
            --inner-shadow: inset 6px 6px 12px #a3b1c6, inset -6px -6px 12px #ffffff;
            --primary: #2c3e50;
            --blue-accent: #3498db;
            --light-grey: #a3b1c6;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        .neu-card { background: var(--bg); border-radius: 20px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .neu-btn { background: var(--bg); border: none; padding: 10px 20px; border-radius: 12px; box-shadow: var(--shadow); cursor: pointer; font-weight: 600; color: var(--primary); transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .neu-btn:active { box-shadow: var(--inner-shadow); transform: scale(0.98); }
        .neu-input { background: var(--bg); border: none; padding: 12px; border-radius: 10px; box-shadow: var(--inner-shadow); width: 100%; box-sizing: border-box; margin-bottom: 10px; font-weight: bold; }
        
        .logo-3d { font-size: 2.2rem; font-weight: 900; color: var(--blue-accent); text-transform: uppercase; letter-spacing: 4px; padding: 15px 35px; background: var(--bg); border-radius: 50px; box-shadow: 10px 10px 20px var(--light-grey), -10px -10px 20px #ffffff; cursor: pointer; transition: 0.3s; border: none; outline: none; text-shadow: 1px 1px 0px #ffffff; }
        .logo-3d:active { box-shadow: inset 6px 6px 12px var(--light-grey), inset -6px -6px 12px #ffffff; transform: translateY(2px); }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .nav-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; }
        .page-content { display: none; }
        .active { display: block; }

        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(135px, 1fr)); gap: 12px; }
        .market-item { text-align: center; cursor: pointer; padding: 10px; border-radius: 15px; font-size: 0.8rem; transition: 0.3s; }
        .market-item:hover { box-shadow: var(--inner-shadow); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #c2c9d6; text-align: left; }
        .sub-total { background: #f8f9fa; font-weight: bold; color: #2c3e50; padding: 8px; border-radius: 8px; display: block; text-align: right; margin-top: 5px; box-shadow: var(--inner-shadow); }
        .ebitda-header { background: #27ae60; color: white; padding: 15px; border-radius: 15px; font-size: 1.3rem; font-weight: bold; text-align: center; margin-top: 10px; }
        
        .profile-img-box { width: 110px; height: 110px; border-radius: 50%; box-shadow: var(--shadow); object-fit: cover; margin-bottom: 10px; }
        #tv-chart-main, #tv-analysis-terminal { height: 600px; border-radius: 20px; overflow: hidden; }
    </style>
</head>
<body>

<header>
    <button class="neu-btn" onclick="showPage('auth-login-page')"><i class="fas fa-user"></i> Profilim</button>
    <button class="logo-3d" onclick="location.reload()">FİNANS SEPETİ</button>
    <div id="live-clock" style="font-weight: 600;"></div>
</header>

<div class="nav-bar neu-card">
    <button class="neu-btn" onclick="showPage('markets-page')">Piyasalar</button>
    <button class="neu-btn" onclick="showPage('add-investment')">Yatırım Ekle</button>
    <button class="neu-btn" onclick="showPage('portfolio-page')">Portföyüm</button>
    <button class="neu-btn" onclick="showPage('monthly-portfolio')">Aylık Portföy</button>
    <button class="neu-btn" onclick="showPage('yearly-portfolio')">Yıllık Portföy</button>
    <button class="neu-btn" onclick="showPage('ebitda-page')">Harcamalar-Ebitda</button>
    <button class="neu-btn" onclick="showPage('analysis-page')">Teknik Analiz</button>
    <button class="neu-btn" onclick="showPage('news-page')">Haberler</button>
</div>

<div id="auth-login-page" class="page-content">... (Oturum Aç İçeriği) ...</div>
<div id="full-profile-page" class="page-content">... (Profil İçeriği) ...</div>

<div id="add-investment" class="page-content">
    <div class="neu-card">
        <h3>Yatırım Girişi</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <input type="text" id="asset-name" class="neu-input" placeholder="Ürün Adı">
                <input type="number" id="unit-p" class="neu-input" placeholder="Birim Fiyat" oninput="calcInv()">
                <input type="number" id="unit-a" class="neu-input" placeholder="Adet / Gram" oninput="calcInv()">
                <div class="sub-total">İşlem Tutarı: <span id="cur-total">0.00</span> TL</div>
            </div>
            <div>
                <input type="date" id="inv-date" class="neu-input">
                <button class="neu-btn" style="width:100%; background:#27ae60; color:white; height:100px;" onclick="saveInvestment()">VERİ TABANINA KAYDET</button>
            </div>
        </div>
    </div>
</div>

<div id="portfolio-page" class="page-content">
    <div class="neu-card">
        <h3>Portföyüm</h3>
        <table id="port-table"><thead><tr><th>Ürün</th><th>Miktar</th><th>Toplam Maliyet</th></tr></thead><tbody id="port-body"></tbody></table>
    </div>
</div>

<div id="monthly-portfolio" class="page-content">
    <div class="neu-card" id="monthly-container">
        <h3>Aylık Alımlar</h3>
        </div>
</div>

<div id="yearly-portfolio" class="page-content">
    <div class="neu-card">
        <h3>Yıllık Portföy (Kümülatif)</h3>
        <table id="yearly-table"><thead><tr><th>Ürün</th><th>Toplam Adet</th></tr></thead><tbody id="yearly-body"></tbody></table>
        <button class="neu-btn" onclick="exportXls('yearly-table')">Yıllık Raporu Excel İndir</button>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    let port_db = JSON.parse(localStorage.getItem('f_port')) || [];
    const aylar = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];

    function calcInv() { 
        let p = document.getElementById('unit-p').value || 0;
        let a = document.getElementById('unit-a').value || 0; 
        document.getElementById('cur-total').innerText = (p * a).toFixed(2); 
    }

    // YENİLENEN KAYDETME VE AKTİFLEŞTİRME FONKSİYONU
    function saveInvestment() {
        const urun = document.getElementById('asset-name').value;
        const fiyat = parseFloat(document.getElementById('unit-p').value);
        const adet = parseFloat(document.getElementById('unit-a').value);
        const tarih = document.getElementById('inv-date').value;

        if(!urun || !fiyat || !adet || !tarih) { alert("Tüm alanları doldurun!"); return; }

        const tarihObj = new Date(tarih);
        const ay = aylar[tarihObj.getMonth()];
        const toplam = fiyat * adet;

        const veri = {
            id: Date.now(),
            urun: urun.toUpperCase(),
            fiyat: fiyat,
            adet: adet,
            toplam: toplam,
            ay: ay,
            tarih: tarih
        };

        port_db.push(veri);
        localStorage.setItem('f_port', JSON.stringify(port_db));
        alert("Yatırım Portföye ve Aylık Arşive Kaydedildi!");
        
        // Formu temizle
        document.getElementById('asset-name').value = "";
        document.getElementById('unit-p').value = "";
        document.getElementById('unit-a').value = "";
        
        renderAllPortfolios(); // Tabloları güncelle
    }

    function renderAllPortfolios() {
        const portBody = document.getElementById('port-body');
        const monthlyContainer = document.getElementById('monthly-container');
        const yearlyBody = document.getElementById('yearly-body');

        portBody.innerHTML = "";
        monthlyContainer.innerHTML = "<h3>Aylık Alımlar</h3>";
        yearlyBody.innerHTML = "";

        let yillikOzet = {};

        // 1. Portföyüm ve Yıllık Hazırlık
        port_db.forEach(v => {
            portBody.innerHTML += `<tr><td>${v.urun}</td><td>${v.adet}</td><td>${v.toplam.toFixed(2)} TL</td></tr>`;
            yillikOzet[v.urun] = (yillikOzet[v.urun] || 0) + v.adet;
        });

        // 2. Aylık Bazda Ayırma ve Canlı Fiyat Sütunu
        aylar.forEach(ay => {
            const ayVerileri = port_db.filter(d => d.ay === ay);
            if(ayVerileri.length > 0) {
                let tableId = `table-${ay}`;
                let html = `<div class="neu-card" style="margin-top:15px;">
                    <h4>${ay} Ayı Detayları</h4>
                    <table id="${tableId}">
                        <thead><tr><th>Ürün</th><th>Maliyet</th><th>Adet</th><th>Toplam</th><th>Canlı Fiyat</th><th>K/Z</th></tr></thead>
                        <tbody>`;
                
                ayVerileri.forEach(v => {
                    // Canlı fiyat simülasyonu (Burada gerçek API entegre edilebilir)
                    let canli = (v.fiyat * 1.05).toFixed(2); 
                    let kz = ((canli - v.fiyat) * v.adet).toFixed(2);
                    html += `<tr>
                        <td>${v.urun}</td><td>${v.fiyat} TL</td><td>${v.adet}</td><td>${v.toplam.toFixed(2)} TL</td>
                        <td
